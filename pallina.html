<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pallina Rimbalzante</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Manteniamo la stessa versione di Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Usiamo un font pulito e moderno */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none; /* Previene lo zoom o lo scroll su mobile al tocco */
            overflow: hidden; /* Nasconde le barre di scorrimento */
        }

        /* *** AGGIORNAMENTO CRUCIALE: Rendi il contenitore del gioco FLESSIBILE *** */
        #game-container {
            position: absolute; /* Usiamo absolute per l'adattabilità al 100% dell'area */
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%; 
            border-radius: 0; /* Rimuoviamo i bordi arrotondati per coprire tutto lo schermo su mobile */
            
            background-color: #994c30; 
            background-image: url('sfondo-mattoni.jpg'); 
            background-size: 300px 300px; 
            background-repeat: repeat; 
            background-position: top left;
            border-color: #6d412e;
        }
        
        /* NUOVO STILE: Marciapiede/Pavimento */
        #ground {
            background-color: #5d5d5d;
            background-image: linear-gradient(0deg, transparent 50%, rgba(0,0,0,0.3) 50%),
                              linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.3) 50%);
            background-size: 100% 25px, 25px 100%;
            background-position: 0 0, 12.5px 0;
            border-top: 8px solid #333;
            box-shadow: inset 0 10px 20px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            z-index: 10;
        }
        
        /* Stile per la pallina con un gradiente e un'ombra per darle profondità */
        #ball {
            /* Le dimensioni saranno gestite in JS in base alla dimensione dello schermo */
            width: 60px; 
            height: 60px;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            user-select: none;
            transition: transform 0.3s ease-out, background 0.3s ease-out, opacity 0.3s ease-out; 
            z-index: 20; 
        }

        /* *** STILE PER L'ELEMENTO SCIA *** */
        .trail-element {
            position: absolute;
            border-radius: 50%;
            opacity: 0; 
            transition: opacity 0.3s ease-out, transform 0.3s ease-out; 
            pointer-events: none; 
            z-index: 15; 
        }

        /* Stili per la selezione della pallina */
        .ball-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: transform 0.1s ease-in-out, border 0.1s ease-in-out;
            margin: 0 5px;
            border: 3px solid transparent; 
        }
        
        .ball-option:hover {
            transform: scale(1.1);
        }

        .ball-option.selected {
            border-color: #fde047; 
            transform: scale(1.2);
            box-shadow: 0 0 15px #fde047;
        }

        /* Classi specifiche per il background delle palline */
        .ball-1 { background: radial-gradient(circle at 30% 30%, #87CEEB, #4682B4); } 
        .ball-2 { background: radial-gradient(circle at 70% 30%, #FF4500, #8B0000); } 
        .ball-3 { background: radial-gradient(circle at 30% 70%, #FFFF00, #DAA520); } 
        .ball-4 { background: radial-gradient(circle at 50% 50%, #EE82EE, #4B0082); } 
        .ball-5 { background: radial-gradient(circle at 50% 50%, #90EE90, #3CB371); } 

        /* *** IMPORTANTE: Transizione per la dissolvenza della splash screen *** */
        #splash-screen {
             transition: opacity 1000ms ease-in-out; 
        }

        /* Stile per il pulsante audio (nascosto quando l'audio è attivo) */
        #audio-toggle-button {
            transition: opacity 0.3s;
        }
        
        /* Adattamento per dispositivi piccoli (Smartphone) */
        @media (max-width: 640px) {
            #game-container {
                /* Copre interamente la viewport senza margini */
                border-radius: 0;
            }
            .text-6xl {
                font-size: 3rem; /* Dimensione del testo più piccola per la splash screen */
            }
            .text-2xl {
                font-size: 1.25rem;
            }
        }

    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center h-screen m-0 p-0">

    <!-- Rimuovo max-w-md e max-h-[800px] per l'adattabilità completa su mobile -->
    <div id="game-container" class="relative shadow-2xl overflow-hidden border-2 border-sky-500">
        
        <!-- ELEMENTO PER L'HIGH SCORE -->
        <div id="high-score-display" class="absolute top-4 right-4 text-white text-xl font-semibold bg-sky-600/50 p-2 rounded-lg shadow-md z-30">
            Record: 0
        </div>

        <!-- ELEMENTO PER IL PUNTEGGIO -->
        <div id="score-display" class="absolute top-16 left-1/2 -translate-x-1/2 text-sky-400 font-bold text-4xl z-30 p-2 rounded-lg text-center">
            Punti: 0<br><span id="combo-display" class="text-lg text-yellow-300">Combo: 0</span>
        </div>
        
        <!-- La nostra pallina (z-index: 20) -->
        <div id="ball"></div>
        
        <!-- Elemento per il Marciapiede/Pavimento (z-index: 10) -->
        <div id="ground" class="absolute bottom-0 left-0 w-full h-[50px] z-10"></div> 
        
        <!-- MESSAGGIO DI FINE PARTITA (Nascosto di default) -->
        <div id="game-over-message" class="absolute inset-0 flex items-center justify-center text-white text-4xl font-extrabold bg-black/70 z-40 hidden">
            <div class="text-center p-8 rounded-xl bg-red-700/80 shadow-2xl">
                <p>GAME OVER!</p>
                <p class="text-lg mt-2">Nuova partita in arrivo...</p>
            </div>
        </div>
        
        <!-- SCHERMO DI INTRODUZIONE (Splash Screen) - Z-INDEX MAX -->
        <div id="splash-screen" class="absolute inset-0 flex flex-col items-center justify-center text-white z-60 bg-gray-900 opacity-100 transition-opacity duration-1000">
            <div class="text-center p-8">
                <!-- LOGO IMMAGINE -->
                <div class="mx-auto w-24 h-24 flex items-center justify-center mb-6 shadow-2xl transform rotate-3 scale-110 animate-pulse rounded-full overflow-hidden border-4 border-white/50">
                    <!-- Utilizzo di un placeholder generico come fallback per l'immagine logo -->
                    <img src="logo78.jpg" onerror="this.onerror=null;this.src='https://placehold.co/96x96/60A5FA/FFFFFF?text=Logo';" alt="Logo 78" class="w-full h-full object-cover">
                </div>
                <h1 class="text-6xl font-extrabold text-white mb-2 tracking-wider drop-shadow-lg">Pallina Rimbalzante</h1>
                <p class="text-2xl text-sky-400 mt-4">Caricamento...</p>
            </div>
        </div>

        <!-- MESSAGGIO DI INIZIO GIOCO (OVERLAY) -->
        <div id="start-overlay" class="absolute inset-0 flex items-center justify-center text-white z-50 hidden">
            <div class="text-center p-8 rounded-xl bg-gray-900/90 shadow-2xl border-2 border-sky-500 max-w-sm w-11/12">
                
                <!-- SEZIONE LOGO E TITOLO -->
                <div class="mb-8">
                    <!-- LOGO IMMAGINE -->
                    <div class="mx-auto w-20 h-20 flex items-center justify-center mb-4 shadow-lg rounded-full overflow-hidden border-2 border-white/50">
                         <img src="logo78.jpg" onerror="this.onerror=null;this.src='https://placehold.co/80x80/60A5FA/FFFFFF?text=Logo';" alt="Logo 78" class="w-full h-full object-cover">
                    </div>
                    <h1 class="text-5xl font-extrabold text-white mb-2">Pallina Rimbalzante</h1>
                    <p class="text-xl text-sky-400">Tocca la pallina per mantenerla in aria.</p>
                </div>
                <!-- FINE SEZIONE LOGO E TITOLO -->
                
                <!-- NUOVO CONTENITORE PER LA SELEZIONE DELLA PALLINA -->
                <p class="text-lg mt-4 mb-2 text-gray-300">Scegli la tua pallina:</p>
                <div id="ball-selection-container" class="flex justify-center mb-6">
                    <!-- Le opzioni delle palline verranno generate qui da JavaScript -->
                </div>
                
                <!-- PULSANTE PER L'ATTIVAZIONE DELL'AUDIO -->
                <button id="audio-toggle-button" class="flex items-center justify-center w-full px-4 py-2 bg-yellow-600 hover:bg-yellow-700 active:bg-yellow-800 text-lg font-bold rounded-lg shadow-md transition duration-150 mb-4" onclick="toggleAudio(true)">
                    <!-- Icona speaker/volume -->
                    <svg id="audio-icon" class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    Attiva Audio e Musica
                </button>
                
                <button id="start-button" class="px-8 py-4 bg-sky-600 hover:bg-sky-700 active:bg-sky-800 text-3xl font-bold rounded-xl shadow-lg transition duration-150 transform hover:scale-105">
                    START
                </button>
                <p class="text-sm mt-4 text-gray-400">Record: <span id="start-high-score">0</span></p>
            </div>
        </div>
    </div>

    <script>
        // --- INIZIALIZZAZIONE ELEMENTI HTML ---
        const ball = document.getElementById('ball');
        const gameContainer = document.getElementById('game-container');
        const ground = document.getElementById('ground'); 
        const scoreDisplay = document.getElementById('score-display');
        const comboDisplay = document.getElementById('combo-display');
        const highScoreDisplay = document.getElementById('high-score-display');
        const gameOverMessage = document.getElementById('game-over-message');
        const startOverlay = document.getElementById('start-overlay');
        const startButton = document.getElementById('start-button');
        const startHighScoreDisplay = document.getElementById('start-high-score');
        const ballSelectionContainer = document.getElementById('ball-selection-container'); 
        const splashScreen = document.getElementById('splash-screen'); 
        const audioToggleButton = document.getElementById('audio-toggle-button');
        
        // --- VARIABILI GLOBALI PER LA FISICA DINAMICA ---
        let BALL_SIZE_PX = 60; // Dimensione iniziale della pallina
        let BASE_GRAVITY = 0.6;
        let BASE_JUMP_FORCE = -15;
        const restitution = 0.85;     
        const TAP_FORCE_X = 10;       
        const dampingX = 0.98;        

        // Variabili Dinamiche
        let gravity = BASE_GRAVITY;
        let jumpForce = BASE_JUMP_FORCE;
        let positionY = 0;
        let velocityY = 0;
        let positionX = 0; 
        let velocityX = 0;

        // Stato di Gioco e Punteggio
        let score = 0;
        // *** AGGIORNAMENTO: Carica l'High Score da localStorage ***
        let highScore = parseInt(localStorage.getItem('bouncingBallHighScore') || '0', 10); 
        let consecutiveTaps = 0;
        let isClampedToGround = false;
        let isGameOver = false; 
        let isGameRunning = false;
        let lastSpeedIncreaseScore = 0; 
        let isAudioEnabled = false; 

        // Variabili di selezione
        let selectedBallId = 1; 
        let selectedBallStyle = 'ball-1'; 
        let selectedBallColor = '#4682B4';

        // Variabili audio
        let lastBounceTime = 0;        
        const minTimeBetweenBounces = 0.05; 
        let bgMusicLoop; 
        let introMusicLoop; 
        
        // --- ADATTABILITÀ (RESPONSIVE) ---
        // Funzione per calcolare le dimensioni e le forze in base alla viewport
        function calculateGameMetrics() {
            const containerHeight = gameContainer.offsetHeight;
            
            // Definiamo la dimensione della pallina in base alla larghezza della viewport (es. 15% della larghezza)
            // Usiamo Math.min per non farla diventare troppo grande su schermi enormi
            BALL_SIZE_PX = Math.min(gameContainer.offsetWidth * 0.15, 80); 
            
            // Scala le forze in base all'altezza del contenitore per mantenere la stessa sensazione di gioco
            const heightScale = containerHeight / 800; // 800px era l'altezza target
            gravity = BASE_GRAVITY * heightScale;
            jumpForce = BASE_JUMP_FORCE * heightScale;

            // Aggiorna immediatamente le dimensioni della pallina
            ball.style.width = `${BALL_SIZE_PX}px`;
            ball.style.height = `${BALL_SIZE_PX}px`;
            
            // Aggiorna la posizione X per centrarla
            positionX = gameContainer.offsetWidth / 2 - BALL_SIZE_PX / 2;
            ball.style.left = `${positionX}px`;
            
            console.log(`Dimensioni aggiornate: Ball=${BALL_SIZE_PX}px, Gravity=${gravity.toFixed(2)}, JumpForce=${jumpForce.toFixed(2)}`);
        }
        
        // Aggiorna le metriche al caricamento e ad ogni resize
        window.addEventListener('load', calculateGameMetrics);
        window.addEventListener('resize', calculateGameMetrics);


        // --- GESTIONE DEI SUONI con Tone.js (Stesse funzioni di prima) ---
        
        async function startAudioContext() {
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                    console.log("Audio Context e Tone.start() Sbloccati.");
                } catch(error) {
                    console.error("Errore nell'avvio di Tone.js:", error);
                    return false;
                }
            }
            if (Tone.Transport.state !== 'started') {
                Tone.Transport.start(); 
            }
            
            isAudioEnabled = true;
            audioToggleButton.style.opacity = '0';
            setTimeout(() => { audioToggleButton.classList.add('hidden'); }, 300);
            return true;
        };
        
        window.toggleAudio = async function(startIntro = false) {
            if (!isAudioEnabled) {
                const started = await startAudioContext();
                if (started && startIntro) {
                    startIntroMusic();
                }
            }
        }

        const jumpSynth = new Tone.Synth({
            oscillator: { type: 'sine' },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }
        }).toDestination();

        const bounceSynth = new Tone.FMSynth({
            envelope: {
                attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1
            },
            volume: -5 
        }).toDestination();
        
        const splashSynth = new Tone.NoiseSynth({
            noise: { type: 'pink' },
            envelope: { attack: 0.01, decay: 0.4, sustain: 0.0, release: 0.05 },
            volume: -10 
        }).toDestination();

        const gameBgSynth = new Tone.Synth({
            oscillator: { type: 'square' },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.2, release: 0.5 },
            volume: -15
        }).toDestination();

        const gameMelody = ["C4", ["E4", "G4"], "C5", ["G4", "E4"], "C4", ["E4", "G4"], "F4", "D4"];
        let gameMelodyIndex = 0;
        const gameBpm = 120;
        const gameNoteDuration = "8n";

        function startGameMusic() {
            if (!isAudioEnabled) return;

            stopMusic(); 
            
            gameMelodyIndex = 0; 
            Tone.Transport.bpm.value = gameBpm;
            
            bgMusicLoop = new Tone.Loop(time => {
                const note = gameMelody[gameMelodyIndex % gameMelody.length];
                if (Array.isArray(note)) {
                    note.forEach(n => gameBgSynth.triggerAttackRelease(n, gameNoteDuration, time));
                } else {
                    gameBgSynth.triggerAttackRelease(note, gameNoteDuration, time);
                }
                gameMelodyIndex++;
            }, gameNoteDuration).start(0);
        }
        
        const introBgSynth = new Tone.PolySynth(Tone.AMSynth, {
            oscillator: { type: 'square' },
            envelope: { attack: 0.05, decay: 0.2, sustain: 0.4, release: 0.5 }, 
            volume: -8 
        }).toDestination();
        
        const introMelody = ["C4", "E4", "G4", "C5", "G4", "C5", "E5", "G5"]; 
        let introMelodyIndex = 0;
        const introBpm = 140;
        const introNoteDuration = "8n";

        function startIntroMusic() {
             if (!isAudioEnabled) return;

            stopMusic(); 
            
            introMelodyIndex = 0; 
            Tone.Transport.bpm.value = introBpm; 
            
            introMusicLoop = new Tone.Loop(time => {
                const note = introMelody[introMelodyIndex % introMelody.length];
                introBgSynth.triggerAttackRelease(note, introNoteDuration, time); 
                introMelodyIndex++;
            }, introNoteDuration).start(0);
        }

        function stopMusic() {
            if (bgMusicLoop) {
                bgMusicLoop.dispose();
                bgMusicLoop = null;
            }
            if (introMusicLoop) {
                introMusicLoop.dispose();
                introMusicLoop = null;
            }
        }


        // Funzione per aggiornare l'interfaccia utente del punteggio
        function updateScoreDisplay() {
            scoreDisplay.firstChild.textContent = `Punti: ${score}`;
            comboDisplay.textContent = `Combo: ${consecutiveTaps}`;
            // *** AGGIORNAMENTO: Mostra il record attuale ***
            highScoreDisplay.textContent = `Record: ${highScore}`;
            startHighScoreDisplay.textContent = highScore; 
        }
        
        // --- LOGICA DI SELEZIONE DELLA PALLINA ---
        const BALL_STYLES = [
            { id: 1, name: 'Cielo', className: 'ball-1' },
            { id: 2, name: 'Fuoco', className: 'ball-2' },
            { id: 3, name: 'Limone', className: 'ball-3' },
            { id: 4, name: 'Magica', className: 'ball-4' },
            { id: 5, name: 'Menta', className: 'ball-5' }
        ];

        window.selectBall = function(id) {
            const newSelection = BALL_STYLES.find(style => style.id === id);
            if (!newSelection) return;

            selectedBallId = id;
            selectedBallStyle = newSelection.className;
            
            switch (id) {
                case 1: selectedBallColor = '#4682B4'; break;
                case 2: selectedBallColor = '#FF4500'; break;
                case 3: selectedBallColor = '#FFFF00'; break;
                case 4: selectedBallColor = '#EE82EE'; break;
                case 5: selectedBallColor = '#3CB371'; break;
                default: selectedBallColor = 'rgba(255,255,255, 0.5)';
            }
            
            ball.className = ''; 
            ball.classList.add(selectedBallStyle);
            
            document.querySelectorAll('.ball-option').forEach(option => {
                option.classList.remove('selected');
                if (parseInt(option.dataset.ballId, 10) === id) {
                    option.classList.add('selected');
                }
            });
        }
        
        function renderBallSelection() {
            ballSelectionContainer.innerHTML = BALL_STYLES.map(style => `
                <div 
                    class="ball-option ${style.className} ${style.id === selectedBallId ? 'selected' : ''}" 
                    data-ball-id="${style.id}" 
                    title="${style.name}"
                    onclick="selectBall(${style.id})"
                ></div>
            `).join('');

            selectBall(selectedBallId); 
        }

        // --- FUNZIONE PER CREARE LA SCIA ---
        let trailCounter = 0;
        const TRAIL_DENSITY = 3; 
        function createTrailElement() {
            if (isClampedToGround && Math.abs(velocityY) < 0.5 && Math.abs(velocityX) < 0.5) return;
            
            trailCounter++;
            if (trailCounter % TRAIL_DENSITY !== 0) return; 

            const trail = document.createElement('div');
            trail.classList.add('trail-element');
            
            const trailColor = selectedBallColor;

            const ballSize = BALL_SIZE_PX;
            const size = ballSize * 0.7; 
            
            const x = positionX + (ballSize - size) / 2;
            const y = positionY + (ballSize - size) / 2;
            
            Object.assign(trail.style, {
                width: `${size}px`,
                height: `${size}px`,
                top: `${y}px`,
                left: `${x}px`,
                backgroundColor: trailColor,
                opacity: '0.4', 
                transform: 'scale(1)',
                boxShadow: `0 0 10px 5px ${trailColor}`
            });

            gameContainer.appendChild(trail);

            setTimeout(() => {
                Object.assign(trail.style, {
                    opacity: '0',
                    transform: 'scale(0.1)',
                });
            }, 50); 

            setTimeout(() => {
                trail.remove();
            }, 350); 
        }
        
        // --- FUNZIONE DI RESET DEL GIOCO/RESPAWN ---
        function resetGame() {
            calculateGameMetrics(); // Ricalcola le metriche per il responsive

            // Reset delle forze iniziali
            gravity = BASE_GRAVITY;
            jumpForce = BASE_JUMP_FORCE;
            lastSpeedIncreaseScore = 0;
            
            positionY = 50; 
            velocityY = 0; 
            velocityX = 0;
            isClampedToGround = false;
            
            // Reset visivo della pallina
            ball.className = '';
            ball.classList.add(selectedBallStyle);
            ball.style.width = `${BALL_SIZE_PX}px`;
            ball.style.height = `${BALL_SIZE_PX}px`;
            ball.style.opacity = '1';
            ball.style.transform = 'scale(1)'; 
            ball.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.3)';
            ball.style.display = 'block'; 

            // Posiziona la pallina centrata
            positionX = gameContainer.offsetWidth / 2 - BALL_SIZE_PX / 2;
            ball.style.top = `${positionY}px`;
            ball.style.left = `${positionX}px`;

            isGameOver = false;
            gameOverMessage.classList.add('hidden');
            updateScoreDisplay(); 
        }

        // --- LOGICA DI AVVIO DEL GIOCO ---
        function startGame() {
            stopMusic(); 
            if (isAudioEnabled) {
                startGameMusic(); 
            }
            
            isGameRunning = true;
            startOverlay.classList.add('hidden');
            resetGame(); 
        }
        
        startButton.addEventListener('mousedown', async (e) => {
            if (!isAudioEnabled) {
                await toggleAudio(false);
            }
            startGame();
            e.preventDefault(); 
        });
        startButton.addEventListener('touchstart', async (e) => {
             if (!isAudioEnabled) {
                await toggleAudio(false);
            }
            startGame();
            e.preventDefault(); 
        }); 

        // --- EVENT LISTENER PER IL TOCCO/CLICK ---
        function handleInteraction(event) {
            if (!isGameRunning || isGameOver) return; 

            if (!isAudioEnabled) {
                startAudioContext(); 
            }

            // Logica del Punteggio, Combo e Aumento Velocità
            score += 10;
            consecutiveTaps++;

            // La difficoltà è scalata in base all'altezza (vedi calculateGameMetrics)
            if (score > 0 && Math.floor(score / 50) > Math.floor(lastSpeedIncreaseScore / 50)) {
                gravity += 0.05 * (gameContainer.offsetHeight / 800); 
                jumpForce -= 1.0 * (gameContainer.offsetHeight / 800); 
                lastSpeedIncreaseScore = score;
            }

            if (consecutiveTaps > 0 && consecutiveTaps % 5 === 0) {
                score += 20;
            }
            
            updateScoreDisplay(); 

            // Logica di Gioco Verticale (Balzo)
            velocityY = jumpForce;
            if(isAudioEnabled) jumpSynth.triggerAttackRelease('C5', '8n');
            
            // Logica di Gioco Orizzontale (Spinta)
            if (Math.abs(velocityX) < 1) {
                 velocityX = Math.random() < 0.5 ? 5 : -5;
            } else {
                velocityX = (velocityX > 0 ? -1 : 1) * (Math.abs(velocityX) + 1); 
            }
            
            velocityX = Math.min(Math.max(velocityX, -TAP_FORCE_X), TAP_FORCE_X);

            isClampedToGround = false;
            
            if (event.cancelable) event.preventDefault(); 
        }

        ball.addEventListener('mousedown', handleInteraction);
        ball.addEventListener('touchstart', handleInteraction);


        // --- GAME LOOP (Il cuore dell'animazione) ---
        function gameLoop() {
            requestAnimationFrame(gameLoop);

            if (!isGameRunning || isGameOver) {
                return;
            }

            // 1. Fisica
            velocityY += gravity;
            velocityX *= dampingX; 

            positionY += velocityY;
            positionX += velocityX;

            // 2. Controlla le collisioni orizzontali
            const containerWidth = gameContainer.offsetWidth;

            if (positionX + BALL_SIZE_PX >= containerWidth) { 
                positionX = containerWidth - BALL_SIZE_PX; 
                velocityX = -velocityX * restitution; 
            } else if (positionX <= 0) { 
                positionX = 0; 
                velocityX = -velocityX * restitution; 
            }
            
            // 3. Controlla le collisioni con il "pavimento"
            const groundHeight = ground.offsetHeight; 
            const groundPosition = gameContainer.offsetHeight - groundHeight - BALL_SIZE_PX;
            
            if (positionY >= groundPosition) {
                
                if (!isClampedToGround) {
                    
                    if (Math.abs(velocityY) > 1.0) { 
                        
                        // --- LOGICA DI FINE PARTITA ---
                        stopMusic(); 
                        
                        // *** AGGIORNAMENTO CRUCIALE: Salva il nuovo record ***
                        if (score > highScore) {
                            highScore = score;
                            localStorage.setItem('bouncingBallHighScore', highScore.toString()); // Salva su localStorage
                        }
                        
                        score = 0; 
                        consecutiveTaps = 0;
                        updateScoreDisplay(); 
                        
                        if(isAudioEnabled) splashSynth.triggerAttackRelease("4n");
                        
                        // Effetto visivo di Splash
                        ball.className = '';
                        ball.style.background = 'radial-gradient(circle, #FF4500, #8B0000)'; 
                        ball.style.transform = 'scale(2.5)'; 
                        ball.style.opacity = '0.0'; 
                        ball.style.boxShadow = '0 0 50px #FF4500';
                        isGameOver = true; 

                        setTimeout(() => {
                            ball.style.display = 'none'; 
                            gameOverMessage.classList.remove('hidden'); 

                            setTimeout(() => {
                                isGameRunning = false; 
                                startOverlay.classList.remove('hidden'); 
                                renderBallSelection(); 
                                if(isAudioEnabled) startIntroMusic(); 
                            }, 1700); 

                        }, 300); 

                    } else { 
                        // Rimbalzo normale
                        if (isAudioEnabled && (Tone.now() - lastBounceTime) > minTimeBetweenBounces) { 
                            lastBounceTime = Tone.now(); 
                            bounceSynth.triggerAttackRelease('G2', '16n', "+0.001"); 
                        }
                        
                        velocityY = -velocityY * restitution;
                    }
                }
                
                positionY = groundPosition;
                isClampedToGround = true;

            } else {
                isClampedToGround = false;
            }
            
            // 4. Creazione Scia
            createTrailElement(); 

            // 5. Aggiorna la posizione visiva della pallina
            ball.style.top = `${positionY}px`;
            ball.style.left = `${positionX}px`;
        }
        
        // --- LOGICA SPLASH SCREEN E AVVIO INIZIALE ---
        function initialSetup() {
            calculateGameMetrics(); // Inizializza le metriche responsive al primo avvio
            updateScoreDisplay(); // Mostra subito l'high score caricato
            
            splashScreen.style.opacity = '1';
            
            setTimeout(() => {
                splashScreen.style.opacity = '0';
            }, 3000); 

            setTimeout(() => {
                splashScreen.classList.add('hidden'); 
                startOverlay.classList.remove('hidden'); 
                renderBallSelection(); 
            }, 4000);
        }

        // --- INIZIO DEL GIOCO ---
        initialSetup(); 
        gameLoop(); 
    </script>

</body>
</html>
